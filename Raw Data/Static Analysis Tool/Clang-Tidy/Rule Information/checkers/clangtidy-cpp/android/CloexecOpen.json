{
  "name": "CloexecOpen",
  "language": "cpp",
  "description": ".. title:: clang-tidy - android-cloexec-open",
  "example": null,
  "cwe": null,
  "cwe-description": null,
  "checker-language": "cpp",
  "loc": 37,
  "branches": 1,
  "apis": 33,
  "test": [
    {
      "description": null,
      "expected-problems": 54,
      "expected-linenumbers": [
        21,
        24,
        27,
        30,
        36,
        39,
        42,
        45,
        51,
        54,
        57,
        60,
        66,
        69,
        72,
        75,
        78,
        81,
        86,
        88,
        90,
        92,
        94,
        96,
        106,
        108,
        110,
        112,
        114,
        116,
        123,
        125,
        127,
        129,
        131,
        133,
        135,
        137,
        139,
        141,
        143,
        145,
        147,
        149,
        151,
        153,
        155,
        157,
        168,
        170,
        172,
        174,
        176,
        178
      ],
      "code": "\n// RUN: %check_clang_tidy --match-partial-fixes %s android-cloexec-open %t\n\n#define O_RDWR 1\n#define O_EXCL 2\n#define __O_CLOEXEC 3\n#define O_CLOEXEC __O_CLOEXEC\n#define TEMP_FAILURE_RETRY(exp) \\\n  ({                            \\\n    int _rc;                    \\\n    do {                        \\\n      _rc = (exp);              \\\n    } while (_rc == -1);        \\\n  })\n\nextern \"C\" int open(const char *fn, int flags, ...);\nextern \"C\" int open64(const char *fn, int flags, ...);\nextern \"C\" int openat(int dirfd, const char *pathname, int flags, ...);\n\nvoid a() {\n  open(\"filename\", O_RDWR);\n  // CHECK-MESSAGES: :[[@LINE-1]]:26: warning: 'open' should use O_CLOEXEC where possible [android-cloexec-open]\n  // CHECK-FIXES: O_RDWR | O_CLOEXEC\n  TEMP_FAILURE_RETRY(open(\"filename\", O_RDWR));\n  // CHECK-MESSAGES: :[[@LINE-1]]:45: warning: 'open' should use O_CLOEXEC where\n  // CHECK-FIXES: O_RDWR | O_CLOEXEC\n  open(\"filename\", O_RDWR | O_EXCL);\n  // CHECK-MESSAGES: :[[@LINE-1]]:35: warning: 'open' should use O_CLOEXEC where\n  // CHECK-FIXES: O_RDWR | O_EXCL | O_CLOEXEC\n  TEMP_FAILURE_RETRY(open(\"filename\", O_RDWR | O_EXCL));\n  // CHECK-MESSAGES: :[[@LINE-1]]:54: warning: 'open' should use O_CLOEXEC where\n  // CHECK-FIXES: O_RDWR | O_EXCL | O_CLOEXEC\n}\n\nvoid b() {\n  open64(\"filename\", O_RDWR);\n  // CHECK-MESSAGES: :[[@LINE-1]]:28: warning: 'open64' should use O_CLOEXEC where possible [android-cloexec-open]\n  // CHECK-FIXES: O_RDWR | O_CLOEXEC\n  TEMP_FAILURE_RETRY(open64(\"filename\", O_RDWR));\n  // CHECK-MESSAGES: :[[@LINE-1]]:47: warning: 'open64' should use O_CLOEXEC where\n  // CHECK-FIXES: O_RDWR | O_CLOEXEC\n  open64(\"filename\", O_RDWR | O_EXCL);\n  // CHECK-MESSAGES: :[[@LINE-1]]:37: warning: 'open64' should use O_CLOEXEC where\n  // CHECK-FIXES: O_RDWR | O_EXCL | O_CLOEXEC\n  TEMP_FAILURE_RETRY(open64(\"filename\", O_RDWR | O_EXCL));\n  // CHECK-MESSAGES: :[[@LINE-1]]:56: warning: 'open64' should use O_CLOEXEC where\n  // CHECK-FIXES: O_RDWR | O_EXCL | O_CLOEXEC\n}\n\nvoid c() {\n  openat(0, \"filename\", O_RDWR);\n  // CHECK-MESSAGES: :[[@LINE-1]]:31: warning: 'openat' should use O_CLOEXEC where possible [android-cloexec-open]\n  // CHECK-FIXES: O_RDWR | O_CLOEXEC\n  TEMP_FAILURE_RETRY(openat(0, \"filename\", O_RDWR));\n  // CHECK-MESSAGES: :[[@LINE-1]]:50: warning: 'openat' should use O_CLOEXEC where\n  // CHECK-FIXES: O_RDWR | O_CLOEXEC\n  openat(0, \"filename\", O_RDWR | O_EXCL);\n  // CHECK-MESSAGES: :[[@LINE-1]]:40: warning: 'openat' should use O_CLOEXEC where\n  // CHECK-FIXES: O_RDWR | O_EXCL | O_CLOEXEC\n  TEMP_FAILURE_RETRY(openat(0, \"filename\", O_RDWR | O_EXCL));\n  // CHECK-MESSAGES: :[[@LINE-1]]:59: warning: 'openat' should use O_CLOEXEC where\n  // CHECK-FIXES: O_RDWR | O_EXCL | O_CLOEXEC\n}\n\nvoid f() {\n  open(\"filename\", 3);\n  // CHECK-MESSAGES: :[[@LINE-1]]:21: warning: 'open' should use O_CLOEXEC where possible [android-cloexec-open]\n  // CHECK-FIXES: 3 | O_CLOEXEC\n  TEMP_FAILURE_RETRY(open(\"filename\", 3));\n  // CHECK-MESSAGES: :[[@LINE-1]]:40: warning: 'open' should use O_CLOEXEC where\n  // CHECK-FIXES: 3 | O_CLOEXEC\n  open64(\"filename\", 3);\n  // CHECK-MESSAGES: :[[@LINE-1]]:23: warning: 'open64' should use O_CLOEXEC where possible [android-cloexec-open]\n  // CHECK-FIXES: 3 | O_CLOEXEC\n  TEMP_FAILURE_RETRY(open64(\"filename\", 3));\n  // CHECK-MESSAGES: :[[@LINE-1]]:42: warning: 'open64' should use O_CLOEXEC where\n  // CHECK-FIXES: 3 | O_CLOEXEC\n  openat(0, \"filename\", 3);\n  // CHECK-MESSAGES: :[[@LINE-1]]:26: warning: 'openat' should use O_CLOEXEC where possible [android-cloexec-open]\n  // CHECK-FIXES: 3 | O_CLOEXEC\n  TEMP_FAILURE_RETRY(openat(0, \"filename\", 3));\n  // CHECK-MESSAGES: :[[@LINE-1]]:45: warning: 'openat' should use O_CLOEXEC where\n  // CHECK-FIXES: 3 | O_CLOEXEC\n\n  int flag = 3;\n  open(\"filename\", flag);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(open(\"filename\", flag));\n  // CHECK-MESSAGES-NOT: warning:\n  open64(\"filename\", flag);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(open64(\"filename\", flag));\n  // CHECK-MESSAGES-NOT: warning:\n  openat(0, \"filename\", flag);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(openat(0, \"filename\", flag));\n  // CHECK-MESSAGES-NOT: warning:\n}\n\nnamespace i {\nint open(const char *pathname, int flags, ...);\nint open64(const char *pathname, int flags, ...);\nint openat(int dirfd, const char *pathname, int flags, ...);\n\nvoid d() {\n  open(\"filename\", O_RDWR);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(open(\"filename\", O_RDWR));\n  // CHECK-MESSAGES-NOT: warning:\n  open64(\"filename\", O_RDWR);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(open64(\"filename\", O_RDWR));\n  // CHECK-MESSAGES-NOT: warning:\n  openat(0, \"filename\", O_RDWR);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(openat(0, \"filename\", O_RDWR));\n  // CHECK-MESSAGES-NOT: warning:\n}\n\n} // namespace i\n\nvoid e() {\n  open(\"filename\", O_CLOEXEC);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(open(\"filename\", O_CLOEXEC));\n  // CHECK-MESSAGES-NOT: warning:\n  open(\"filename\", O_RDWR | O_CLOEXEC);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(open(\"filename\", O_RDWR | O_CLOEXEC));\n  // CHECK-MESSAGES-NOT: warning:\n  open(\"filename\", O_RDWR | O_CLOEXEC | O_EXCL);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(open(\"filename\", O_RDWR | O_CLOEXEC | O_EXCL));\n  // CHECK-MESSAGES-NOT: warning:\n  open64(\"filename\", O_CLOEXEC);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(open64(\"filename\", O_CLOEXEC));\n  // CHECK-MESSAGES-NOT: warning:\n  open64(\"filename\", O_RDWR | O_CLOEXEC);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(open64(\"filename\", O_RDWR | O_CLOEXEC));\n  // CHECK-MESSAGES-NOT: warning:\n  open64(\"filename\", O_RDWR | O_CLOEXEC | O_EXCL);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(open64(\"filename\", O_RDWR | O_CLOEXEC | O_EXCL));\n  // CHECK-MESSAGES-NOT: warning:\n  openat(0, \"filename\", O_CLOEXEC);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(openat(0, \"filename\", O_CLOEXEC));\n  // CHECK-MESSAGES-NOT: warning:\n  openat(0, \"filename\", O_RDWR | O_CLOEXEC);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(openat(0, \"filename\", O_RDWR | O_CLOEXEC));\n  // CHECK-MESSAGES-NOT: warning:\n  openat(0, \"filename\", O_RDWR | O_CLOEXEC | O_EXCL);\n  // CHECK-MESSAGES-NOT: warning:\n  TEMP_FAILURE_RETRY(openat(0, \"filename\", O_RDWR | O_CLOEXEC | O_EXCL));\n  // CHECK-MESSAGES-NOT: warning:\n}\n\nclass G {\npublic:\n  int open(const char *pathname, int flags, ...);\n  int open64(const char *pathname, int flags, ...);\n  int openat(int dirfd, const char *pathname, int flags, ...);\n\n  void h() {\n    open(\"filename\", O_RDWR);\n    // CHECK-MESSAGES-NOT: warning:\n    TEMP_FAILURE_RETRY(open(\"filename\", O_RDWR));\n    // CHECK-MESSAGES-NOT: warning:\n    open64(\"filename\", O_RDWR);\n    // CHECK-MESSAGES-NOT: warning:\n    TEMP_FAILURE_RETRY(open64(\"filename\", O_RDWR));\n    // CHECK-MESSAGES-NOT: warning:\n    openat(0, \"filename\", O_RDWR);\n    // CHECK-MESSAGES-NOT: warning:\n    TEMP_FAILURE_RETRY(openat(0, \"filename\", O_RDWR));\n    // CHECK-MESSAGES-NOT: warning:\n  }\n};"
    }
  ]
}